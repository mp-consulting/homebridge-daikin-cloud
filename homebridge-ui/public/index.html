<!DOCTYPE html>
<html data-bs-theme="auto">
<head>
    <script>
        // Auto-detect dark mode preference
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-bs-theme', 'dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            document.documentElement.setAttribute('data-bs-theme', e.matches ? 'dark' : 'light');
        });
    </script>
    <title>Daikin Cloud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container-fluid p-3">
        <!-- Header with Status -->
        <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <div class="d-flex align-items-center gap-3">
                <h4 class="mb-0">Daikin Cloud</h4>
                <span class="badge" id="status-badge">
                    <span class="status-dot" id="status-indicator"></span>
                    <span id="status-text">Checking...</span>
                </span>
            </div>
            <div class="text-muted small" id="header-info">
                <span id="token-expires-label" class="d-none">Token expires in: </span>
                <span id="token-expires" class="fw-medium"></span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-pills mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-tab="devices" onclick="switchTab('devices')">
                    Devices
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-tab="settings" onclick="switchTab('settings')">
                    Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-tab="auth" onclick="switchTab('auth')">
                    Authentication
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-tab="help" onclick="switchTab('help')">
                    Help
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Devices Tab -->
            <div class="tab-pane active" id="tab-devices">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Discovered Devices</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshDevices()" id="btn-refresh-devices">
                        Refresh
                    </button>
                </div>
                <div id="devices-loading" class="text-center py-5 text-muted">
                    <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                    <p class="mb-0">Loading devices...</p>
                </div>
                <div id="devices-list" class="list-group"></div>
                <div id="devices-empty" class="text-center py-5 d-none">
                    <div class="fs-1 mb-2 opacity-50">ðŸ“±</div>
                    <p class="mb-1">No devices found</p>
                    <p class="text-muted small">Make sure you're authenticated and your Daikin devices are set up in the Onecta app.</p>
                </div>
                <div id="devices-error" class="alert alert-danger d-none"></div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane" id="tab-settings">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Plugin Settings</h5>
                    <span id="settings-status" class="badge d-none"></span>
                </div>

                <!-- Settings Sub-tabs -->
                <ul class="nav nav-tabs nav-fill mb-3">
                    <li class="nav-item">
                        <button class="nav-link active" data-subtab="features" onclick="switchSettingsSubtab('features')">Features</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-subtab="polling" onclick="switchSettingsSubtab('polling')">Polling</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-subtab="network" onclick="switchSettingsSubtab('network')">Network</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-subtab="devices" onclick="switchSettingsSubtab('devices')">Devices</button>
                    </li>
                </ul>

                <!-- Features Subtab -->
                <div class="settings-subtab-content" id="subtab-features">
                    <div class="card">
                        <div class="card-header">Extra Features in HomeKit</div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Enable switches for additional modes in HomeKit</p>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-medium">Powerful Mode</div>
                                        <small class="text-muted">Boost heating/cooling performance</small>
                                    </div>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch" id="showPowerfulMode">
                                    </div>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-medium">Econo Mode</div>
                                        <small class="text-muted">Energy-saving operation</small>
                                    </div>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch" id="showEconoMode">
                                    </div>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-medium">Streamer Mode</div>
                                        <small class="text-muted">Air purification</small>
                                    </div>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch" id="showStreamerMode">
                                    </div>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-medium">Outdoor Silent Mode</div>
                                        <small class="text-muted">Reduce outdoor unit noise</small>
                                    </div>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch" id="showOutdoorSilentMode">
                                    </div>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-medium">Indoor Silent Mode</div>
                                        <small class="text-muted">Quiet fan operation</small>
                                    </div>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch" id="showIndoorSilentMode">
                                    </div>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-medium">Dry Mode</div>
                                        <small class="text-muted">Dehumidification</small>
                                    </div>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch" id="showDryMode">
                                    </div>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-medium">Fan Only Mode</div>
                                        <small class="text-muted">Fan without heating/cooling</small>
                                    </div>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" role="switch" id="showFanOnlyMode">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Polling Subtab -->
                <div class="settings-subtab-content d-none" id="subtab-polling">
                    <div class="card">
                        <div class="card-header">Polling & Updates</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label" for="updateIntervalInMinutes">Update Interval (minutes)</label>
                                <input type="number" class="form-control" id="updateIntervalInMinutes" min="1" max="60" value="15"
                                       placeholder="15 (recommended for Developer Portal)">
                                <div class="form-text">Developer Portal: 15+ min | Mobile App: 1-5 min</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="forceUpdateDelay">Force Update Delay (seconds)</label>
                                <input type="number" class="form-control" id="forceUpdateDelay" min="5" max="300" value="60"
                                       placeholder="60 (recommended for Developer Portal)">
                                <div class="form-text">Developer Portal: 60s | Mobile App: 10s</div>
                            </div>
                            <div class="mb-0 d-none" id="websocket-setting-row">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="enableWebSocket" checked>
                                    <label class="form-check-label" for="enableWebSocket">
                                        <span class="fw-medium">Enable WebSocket</span>
                                        <br><small class="text-muted">Real-time updates (Mobile App only)</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Network Subtab -->
                <div class="settings-subtab-content d-none" id="subtab-network">
                    <div class="card">
                        <div class="card-header">Network Settings</div>
                        <div class="card-body">
                            <div class="mb-0">
                                <label class="form-label" for="oidcCallbackServerBindAddr">OIDC Callback Bind Address</label>
                                <input type="text" class="form-control" id="oidcCallbackServerBindAddr" placeholder="0.0.0.0" value="0.0.0.0"
                                       pattern="^((25[0-5]|(2[0-4]|1\d|[1-9]|)\d)\.?\b){4}$">
                                <div class="form-text">IPv4 address for OAuth callback server (use 0.0.0.0 for all interfaces)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Devices Subtab -->
                <div class="settings-subtab-content d-none" id="subtab-devices">
                    <div class="card">
                        <div class="card-header">Device Visibility in HomeKit</div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Toggle devices to show or hide them in HomeKit</p>
                            <div id="device-toggles-loading" class="text-center py-4">
                                <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                                <p class="mb-0 text-muted">Loading devices...</p>
                            </div>
                            <div id="device-toggles-list" class="list-group list-group-flush"></div>
                            <div id="device-toggles-empty" class="text-center py-4 text-muted d-none">
                                <p class="mb-0">No devices found. Authenticate first to see your devices.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authentication Tab -->
            <div class="tab-pane" id="tab-auth">
                <h5 class="mb-3">Authentication</h5>

                <!-- Auth Mode Selector -->
                <div class="mb-3">
                    <label class="form-label" for="authMode">Authentication Method</label>
                    <select class="form-select" id="authMode" onchange="onAuthModeChange()">
                        <option value="developer_portal">Developer Portal (200 API calls/day)</option>
                        <option value="mobile_app">Mobile App (5000 API calls/day + WebSocket)</option>
                    </select>
                    <div class="form-text" id="auth-mode-hint">
                        Requires API credentials from the Daikin Developer Portal
                    </div>
                </div>

                <!-- Auth Status -->
                <div class="card mb-3" id="auth-status-card">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-auto">
                                <div class="text-muted small text-uppercase">Status</div>
                                <div class="fw-semibold" id="auth-status">Loading...</div>
                            </div>
                            <div class="col-auto" id="auth-mode-display">
                                <div class="text-muted small text-uppercase">Mode</div>
                                <div class="fw-semibold" id="auth-mode-text">Developer Portal</div>
                            </div>
                            <div class="col-auto d-none" id="expires-row">
                                <div class="text-muted small text-uppercase">Expires</div>
                                <div class="fw-semibold" id="auth-token-expires">-</div>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-success" id="btn-test" onclick="testConnection()">
                                Test Connection
                            </button>
                            <button class="btn btn-primary" id="btn-authenticate" onclick="showWizard()">
                                Authenticate
                            </button>
                            <button class="btn btn-primary d-none" id="btn-authenticate-mobile" onclick="showMobileAuthForm()">
                                Configure Credentials
                            </button>
                            <button class="btn btn-danger d-none" id="btn-revoke" onclick="revokeAuth()">
                                Revoke Access
                            </button>
                        </div>
                        <div id="test-result" class="alert mt-3 mb-0 d-none"></div>
                    </div>
                </div>

                <!-- Mobile App Authentication Form -->
                <div class="card d-none" id="mobile-auth-form">
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>Mobile App Authentication</strong><br>
                            Use your Daikin Onecta account credentials (same as the mobile app).<br>
                            <small>Benefits: 5000 API calls/day + real-time WebSocket updates</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="daikinEmail">Daikin Account Email *</label>
                                <input type="email" class="form-control" id="daikinEmail" placeholder="your@email.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="daikinPassword">Daikin Account Password *</label>
                                <input type="password" class="form-control" id="daikinPassword" placeholder="Enter your password">
                            </div>
                        </div>

                        <div id="mobile-auth-errors" class="alert alert-danger d-none"></div>
                        <div id="mobile-auth-success" class="alert alert-success d-none"></div>

                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-outline-secondary" onclick="hideMobileAuthForm()">Cancel</button>
                            <button class="btn btn-primary" id="btn-test-mobile-auth" onclick="testMobileAuth()">
                                Test & Save Credentials
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Setup Wizard for Developer Portal -->
                <div class="card d-none" id="wizard">
                    <div class="card-body">
                        <!-- Wizard Steps -->
                        <div class="d-flex justify-content-between mb-4 position-relative wizard-steps">
                            <div class="wizard-step active" id="step-1">
                                <span class="wizard-step-number">1</span>
                                <span class="wizard-step-label">Configure</span>
                            </div>
                            <div class="wizard-step" id="step-2">
                                <span class="wizard-step-number">2</span>
                                <span class="wizard-step-label">Authorize</span>
                            </div>
                            <div class="wizard-step" id="step-3">
                                <span class="wizard-step-number">3</span>
                                <span class="wizard-step-label">Complete</span>
                            </div>
                        </div>

                        <!-- Step 1: Configuration -->
                        <div class="wizard-content" id="content-1">
                            <div class="alert alert-info">
                                Get your credentials from the
                                <a href="https://developer.cloud.daikineurope.com/" target="_blank">Daikin Developer Portal</a>.
                                <br><small><strong>Redirect URI:</strong> <code>https://&lt;address&gt;:&lt;port&gt;</code></small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="clientId">Client ID *</label>
                                    <input type="text" class="form-control" id="clientId" placeholder="Enter your Client ID">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="clientSecret">Client Secret *</label>
                                    <input type="password" class="form-control" id="clientSecret" placeholder="Enter your Client Secret">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="callbackServerExternalAddress">Callback Server Address *</label>
                                    <input type="text" class="form-control" id="callbackServerExternalAddress" placeholder="Auto-detecting...">
                                    <div class="form-text">Your Homebridge server's IP (auto-detected)</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="callbackServerPort">Callback Server Port</label>
                                    <input type="number" class="form-control" id="callbackServerPort" placeholder="8582" value="8582" min="1" max="65535">
                                </div>
                            </div>

                            <div id="validation-errors" class="alert alert-danger d-none"></div>

                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-outline-secondary" onclick="hideWizard()">Cancel</button>
                                <button class="btn btn-primary" onclick="validateAndProceed()">Continue</button>
                            </div>
                        </div>

                        <!-- Step 2: Authorize -->
                        <div class="wizard-content d-none" id="content-2">
                            <div class="alert alert-info">
                                Click the button below to open the Daikin login page and authenticate with your account.
                            </div>

                            <div id="auth-url-container" class="d-none mb-3">
                                <label class="form-label">Authorization URL:</label>
                                <div class="bg-light p-2 rounded border font-monospace small text-break" id="auth-url"></div>
                                <div class="form-text">If the button doesn't work, copy this URL manually.</div>
                            </div>

                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-outline-secondary" onclick="goToStep(1)">Back</button>
                                <button class="btn btn-primary" id="btn-open-auth" onclick="openAuthUrl()">
                                    Open Daikin Login
                                </button>
                            </div>

                            <!-- Automatic callback status -->
                            <div id="callback-server-status" class="d-none">
                                <div class="alert alert-success">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span><strong>Waiting for authentication...</strong></span>
                                    </div>
                                    <p class="mb-0 mt-2 ms-4">Complete the login in the new window. This page will update automatically.</p>
                                </div>
                            </div>

                            <!-- Manual fallback section -->
                            <div class="accordion" id="manual-callback-section">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#manual-callback-collapse">
                                            Manual entry (if automatic redirect fails)
                                        </button>
                                    </h2>
                                    <div id="manual-callback-collapse" class="accordion-collapse collapse" id="manual-callback-details">
                                        <div class="accordion-body">
                                            <div class="alert alert-warning">
                                                If you see an error page after login, copy the <strong>full URL</strong> from your browser's address bar and paste it below.
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label" for="callbackUrl">Callback URL</label>
                                                <input type="text" class="form-control" id="callbackUrl" placeholder="Paste the full URL from your browser (https://...?code=...)">
                                                <div class="form-text">The URL should contain <code>?code=</code> parameter</div>
                                            </div>
                                            <button class="btn btn-success" onclick="submitCallbackUrl()">Complete Authentication</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Complete -->
                        <div class="wizard-content d-none" id="content-3">
                            <div class="text-center py-4">
                                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px; font-size: 32px;">âœ“</div>
                                <h5>Authentication Successful!</h5>
                                <p id="success-message" class="text-muted">Your Daikin Cloud account is now connected.</p>
                            </div>

                            <div class="alert alert-info">
                                <strong>Next Steps:</strong>
                                <ol class="mb-0">
                                    <li>Save your plugin configuration</li>
                                    <li>Restart Homebridge to apply changes</li>
                                    <li>Your Daikin devices will appear in HomeKit</li>
                                </ol>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button class="btn btn-primary" onclick="finishWizard()">Done</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Tab -->
            <div class="tab-pane" id="tab-help">
                <h5 class="mb-3">Help & Information</h5>

                <!-- API Rate Limit -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>API Rate Limit</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="checkRateLimit()">Check</button>
                    </div>
                    <div class="card-body">
                        <div id="rate-limit-display" class="fw-semibold mb-1">200 requests/day</div>
                        <div class="text-muted small" id="rate-limit-info">The Daikin API limits you to 200 requests per day.</div>
                    </div>
                </div>

                <!-- Useful Links -->
                <div class="card mb-3">
                    <div class="card-header">Useful Links</div>
                    <div class="list-group list-group-flush">
                        <a href="https://developer.cloud.daikineurope.com/" target="_blank" class="list-group-item list-group-item-action">Daikin Developer Portal</a>
                        <a href="https://github.com/mp-consulting/homebridge-daikin-cloud" target="_blank" class="list-group-item list-group-item-action">GitHub Repository</a>
                        <a href="https://github.com/mp-consulting/homebridge-daikin-cloud/issues" target="_blank" class="list-group-item list-group-item-action">Report an Issue</a>
                    </div>
                </div>

                <!-- Troubleshooting -->
                <div class="card">
                    <div class="card-header">Troubleshooting</div>
                    <div class="list-group list-group-flush small">
                        <div class="list-group-item">
                            <div class="fw-semibold">Token expired or invalid</div>
                            <div class="text-muted">Delete token file and restart Homebridge</div>
                        </div>
                        <div class="list-group-item">
                            <div class="fw-semibold">Authentication flow issues</div>
                            <div class="text-muted">Check redirect URI, bind to 0.0.0.0, verify firewall</div>
                        </div>
                        <div class="list-group-item">
                            <div class="fw-semibold">Device not appearing</div>
                            <div class="text-muted">Check logs, verify in Onecta app, check exclusions</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay d-none" id="loading">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="global-error" class="toast-container position-fixed top-0 start-50 translate-middle-x p-3 d-none"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="script.js"></script>
</body>
</html>
