<!DOCTYPE html>
<html>
<head>
    <title>Daikin Cloud Setup</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Authentication Status Card -->
        <div class="card" id="status-card">
            <div class="card-header">
                <span>Authentication Status</span>
                <span class="status-badge not-authenticated" id="status-badge">
                    <span class="status-indicator red"></span>
                    <span id="status-text">Checking...</span>
                </span>
            </div>
            <div class="card-body">
                <div id="status-details">
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value" id="auth-status">Loading...</span>
                    </div>
                    <div class="info-row" id="expires-row" style="display: none;">
                        <span class="info-label">Token Expires</span>
                        <span class="info-value" id="token-expires">-</span>
                    </div>
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-success" id="btn-test" onclick="testConnection()">
                        Test Connection
                    </button>
                    <button class="btn btn-primary" id="btn-authenticate" onclick="showWizard()">
                        Authenticate
                    </button>
                    <button class="btn btn-danger" id="btn-revoke" onclick="revokeAuth()" style="display: none;">
                        Revoke Access
                    </button>
                </div>
                <div id="test-result" class="alert hidden" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- Setup Wizard Card -->
        <div class="card hidden" id="wizard-card">
            <div class="card-header">
                Setup Wizard
            </div>
            <div class="card-body">
                <div class="steps">
                    <div class="step active" id="step-1">
                        <span class="step-number">1</span>
                        <span class="step-label">Configuration</span>
                    </div>
                    <div class="step" id="step-2">
                        <span class="step-number">2</span>
                        <span class="step-label">Authorize</span>
                    </div>
                    <div class="step" id="step-3">
                        <span class="step-number">3</span>
                        <span class="step-label">Complete</span>
                    </div>
                </div>

                <!-- Step 1: Configuration -->
                <div class="wizard-content active" id="content-1">
                    <div class="alert alert-info">
                        You need credentials from the
                        <a href="https://developer.cloud.daikineurope.com/" target="_blank" class="link">Daikin Developer Portal</a>.
                        <br>
                        Create an application and copy the Client ID and Secret.
                    </div>

                    <div class="form-group">
                        <label class="form-label">Client ID *</label>
                        <input type="text" class="form-input" id="clientId" placeholder="Enter your Client ID">
                        <div class="form-hint">From your Daikin Developer Portal application</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Client Secret *</label>
                        <input type="password" class="form-input" id="clientSecret" placeholder="Enter your Client Secret">
                        <div class="form-hint">Keep this secret and never share it</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Callback Server Address *</label>
                        <input type="text" class="form-input" id="callbackServerExternalAddress" placeholder="e.g., 192.168.1.100 or your.domain.com">
                        <div class="form-hint">Your Homebridge server's external IP or domain (not localhost)</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Callback Server Port</label>
                        <input type="text" class="form-input" id="callbackServerPort" placeholder="8582" value="8582">
                        <div class="form-hint">Port for the OAuth callback server (default: 8582)</div>
                    </div>

                    <div id="validation-errors" class="alert alert-danger hidden"></div>

                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="hideWizard()">Cancel</button>
                        <button class="btn btn-primary" onclick="validateAndProceed()">Continue</button>
                    </div>
                </div>

                <!-- Step 2: Authorize -->
                <div class="wizard-content" id="content-2">
                    <div class="alert alert-warning">
                        Click the button below to open the Daikin login page in a new tab.
                        After logging in, you'll be redirected automatically.
                    </div>

                    <div id="callback-server-status" class="alert alert-info hidden">
                        <strong>Callback server is running.</strong>
                        Authentication will complete automatically after you log in.
                        <br><br>
                        <em>Note: Your browser may show a certificate warning. This is normal for the self-signed certificate. Click "Advanced" and proceed to continue.</em>
                    </div>

                    <div id="auth-url-container" class="hidden">
                        <p><strong>Authorization URL:</strong></p>
                        <div class="auth-url-box" id="auth-url"></div>
                        <p class="form-hint">If the button doesn't work, copy this URL and open it in a new browser tab.</p>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="goToStep(1)">Back</button>
                        <button class="btn btn-primary" id="btn-open-auth" onclick="openAuthUrl()">
                            Open Daikin Login
                        </button>
                    </div>

                    <div style="margin-top: 30px;">
                        <p><strong>Manual fallback: If automatic redirect doesn't work, enter the code from the URL:</strong></p>
                        <div class="form-group">
                            <label class="form-label">Authorization Code</label>
                            <input type="text" class="form-input" id="authCode" placeholder="Paste the code from the URL">
                            <div class="form-hint">Look for ?code=XXXXX in the URL after authorization</div>
                        </div>
                        <button class="btn btn-success" onclick="submitAuthCode()">Complete Authentication</button>
                    </div>
                </div>

                <!-- Step 3: Complete -->
                <div class="wizard-content" id="content-3">
                    <div class="alert alert-success" id="success-message">
                        Authentication successful! Your Daikin Cloud account is now connected.
                    </div>

                    <div class="alert alert-info">
                        <strong>Next Steps:</strong>
                        <ol style="margin: 10px 0 0 0; padding-left: 20px;">
                            <li>Save your plugin configuration</li>
                            <li>Restart Homebridge to apply changes</li>
                            <li>Your Daikin devices will appear in HomeKit</li>
                        </ol>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="finishWizard()">Done</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Card -->
        <div class="card" id="devices-card">
            <div class="card-header">
                <span>Discovered Devices</span>
                <button class="btn btn-sm btn-outline" onclick="refreshDevices()" id="btn-refresh-devices">
                    Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="devices-loading" class="hidden" style="text-align: center; padding: 20px;">
                    <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                    <p style="margin-top: 10px; color: #666;">Loading devices...</p>
                </div>
                <div id="devices-list"></div>
                <div id="devices-empty" class="hidden" style="text-align: center; padding: 20px; color: #666;">
                    <p>No devices found. Make sure you're authenticated and your Daikin devices are set up.</p>
                </div>
                <div id="devices-error" class="alert alert-danger hidden" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card">
            <div class="card-header">
                Help & Information
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Developer Portal</span>
                    <a href="https://developer.cloud.daikineurope.com/" target="_blank" class="link">
                        developer.cloud.daikineurope.com
                    </a>
                </div>
                <div class="info-row">
                    <span class="info-label">API Rate Limit</span>
                    <span class="info-value" id="rate-limit-display">200 requests/day</span>
                    <button class="btn btn-sm btn-outline" onclick="checkRateLimit()">Check</button>
                </div>
                <div class="info-row">
                    <span class="info-label">Documentation</span>
                    <a href="https://github.com/mp-consulting/homebridge-daikin-cloud" target="_blank" class="link">
                        GitHub Repository
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay hidden" id="loading">
        <div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
    </div>

    <div id="global-error" class="alert alert-danger hidden" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1001; max-width: 500px;"></div>

    <script src="script.js"></script>
</body>
</html>
